<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient - Create Account</title>
    <!-- <link rel="stylesheet" href="../Patient/patientlogin.css"> -->
    <link rel="icon" href="../media/logo/EJPL.png" type="image/x-icon">
    <link href="../output.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="../components/components-mainpage/navbarfetch-mainpage.js"></script>
</head>

<body class="min-h-screen bg-slate-50">
    <header>
        <div id="navbar-container"></div>
    </header>
    <main
        class="flex justify-center items-center min-h-[calc(100vh-4rem)] mt-20 sm:mt-20 md:mt-10 overflow-y-auto pt-4">
        <section class="container flex justify-center items-center max-w-[95%] sm:max-w-full mt-0 mb-0 sm:mt-6 sm:mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 w-full max-w-lg mb-4 mt-4 sm:max-w-xl">
                <h1 class="text-4xl font-bold font-inter text-center">Create Account</h1>
                <div class="flex flex-row items-center justify-center gap-1 mt-1 mb-2">
                    <label class="text-xs font-inter text-gray-700 text-center" for="email">Already have an
                        account?</label>
                    <a href="../Patient/login-patient.html"
                        class="text-xs text-gray-700 hover:underline font-inter font-bold text-center">Login Here</a>
                </div>
                <div class="login-form mt-6 w-full flex flex-col justify-center items-center">
                    <div class="flex flex-col w-full">
                        <div class="sm:flex sm:gap-2">
                            <div class="flex flex-col w-full">
                                <label class="text-sm font-inter font-semibold text-black mb-2" for="firstname">First
                                    Name</label>
                                <input type="text" id="first-name" placeholder="Juan"
                                    class="input-field w-full px-3 mb-4 h-10 border border-gray-300 rounded pl-2"
                                    required>
                                <div id="first-name-error"
                                    class="error-message text-xs font-inter font-bold mb-4 text-red-500"></div>
                            </div>
                            <div class="flex flex-col w-full">
                                <label class="text-sm font-inter font-semibold text-black mb-2" for="lastName">Last
                                    Name</label>
                                <input type="text" id="last-name" placeholder="Dela Cruz"
                                    class="input-field w-full px-3 mb-4 h-10 border border-gray-300 rounded pl-2"
                                    required>
                                <div id="last-name-error"
                                    class="error-message text-xs font-inter font-bold mb-4 text-red-500"></div>
                            </div>
                        </div>
                        <div class="sm:flex sm:gap-2">
                            <div class="flex flex-col w-full">
                                <label class="text-sm font-inter font-semibold text-black mb-2" for="email">Email
                                    Address</label>
                                <input type="email" id="email" placeholder="juandelacruz@gmail.com"
                                    class="input-field w-full px-3 mb-4 h-10 border border-gray-300 rounded pl-2"
                                    required>
                                <div id="email-error"
                                    class="error-message text-xs font-inter font-bold mb-4 text-red-500"></div>
                            </div>
                            <div class="date-picker-container flex flex-col w-full">
                                <label class="text-sm font-inter font-semibold text-black mb-2"
                                    for="birthday">Birthday</label>
                                <input type="date" id="birthday"
                                    class="input-field w-full px-3 mb-4 h-10 border border-gray-300 rounded pl-2 date-input"
                                    required>
                                <div id="birthday-error"
                                    class="error-message text-xs font-inter font-bold mb-4 text-red-500"></div>
                            </div>
                        </div>
                        <div class="flex flex-col w-full">
                            <label class="text-sm font-inter font-semibold text-black mb-2" for="password">Password</label>
                            <div class="relative">
                                <input type="password" id="password" placeholder="••••••••"
                                    class="input-field w-full px-3 mb-4 h-10 border border-gray-300 rounded pl-2"
                                    required>
                                <button type="button" id="toggle-password" class="absolute right-2 top-2 text-gray-500">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="password-checklist" class="text-xs font-inter text-gray-700 mb-4 hidden">
                                <ul>
                                    <li id="length-check" class="text-gray-500">• At least 8 characters</li>
                                    <li id="number-check" class="text-gray-500">• At least one number</li>
                                    <li id="uppercase-check" class="text-gray-500">• At least one uppercase letter</li>
                                    <li id="lowercase-check" class="text-gray-500">• At least one lowercase letter</li>
                                    <li id="special-check" class="text-gray-500">• At least one special character</li>
                                </ul>
                            </div>
                            <div id="password-error" class="error-message text-xs font-inter font-bold mb-4 text-red-500"></div>
                        </div>
                        <div class="flex flex-col w-full">
                            <label class="text-sm font-inter font-semibold text-black mb-2" for="changepassword">Confirm
                                Password</label>
                            <div class="relative">
                                <input type="password" id="confirm-password" placeholder="••••••••"
                                    class="input-field w-full px-3 mb-4 h-10 border border-gray-300 rounded pl-2"
                                    required>
                                <button type="button" id="toggle-confirm-password"
                                    class="absolute right-2 top-2 text-gray-500">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="confirm-password-error"
                                class="error-message text-xs font-inter font-bold mb-4 text-red-500"></div>
                        </div>
                        <button id="create-account-button"
                            class="create-button w-full bg-[#2C4A66] text-white px-4 py-2 rounded hover:bg-opacity-90 font-inter font-bold mt-4">Create
                            Account</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        function goPatientBack() {
            window.location.href = "../main page/home.html";
        }

        // document.querySelector('.calendar-icon').addEventListener('click', function() {
        //     const dateInput = document.querySelector('#birthday');
        //     dateInput.showPicker();
        // });

        document.querySelector('#birthday').addEventListener('change', function () {
            const dateInput = this.value;
            const [year, month, day] = dateInput.split('-');
            const formattedDate = `${monthNames[parseInt(month, 10) - 1]} ${day}, ${year}`;
            const birthdayPlaceholder = document.querySelector('#birthday-placeholder');
            if (birthdayPlaceholder) {
                birthdayPlaceholder.value = formattedDate;
            }
        });

        document.getElementById('toggle-password').addEventListener('click', function () {
            let passwordInput = document.getElementById('password'); // Use 'let' instead of 'const'
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        document.getElementById('toggle-confirm-password').addEventListener('click', function () {
            const confirmPasswordInput = document.getElementById('confirm-password');
            const icon = this.querySelector('i');
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                confirmPasswordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        document.getElementById('create-account-button').addEventListener('click', async function (event) {
            event.preventDefault(); // Prevent default behavior

            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const birthday = document.getElementById('birthday').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();

            // Clear previous error messages
            document.querySelectorAll('.error-message').forEach(element => {
                element.textContent = ''; // Clear error messages
            });

            let hasError = false;

            // Validate First Name
            if (!firstName) {
                document.getElementById('first-name-error').textContent = 'First Name is required.';
                hasError = true;
            } else if (!/^[A-Za-z]{1,20}$/.test(firstName)) {
                document.getElementById('first-name-error').textContent = 'First Name must contain only letters and be up to 20 characters.';
                hasError = true;
            }

            // Validate Last Name
            if (!lastName) {
                document.getElementById('last-name-error').textContent = 'Last Name is required.';
                hasError = true;
            } else if (!/^[A-Za-z\s]{1,20}$/.test(lastName)) { // Allow letters and spaces
                document.getElementById('last-name-error').textContent = 'Last Name must contain only letters, spaces, and be up to 20 characters.';
                hasError = true;
            }

            // Validate Birthday
            if (!birthday) {
                document.getElementById('birthday-error').textContent = 'Birthday is required.';
                hasError = true;
            } else {
                const birthDate = new Date(birthday);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                if (age < 18) {
                    document.getElementById('birthday-error').textContent = 'You must be at least 18 years old.';
                    hasError = true;
                }
            }

            // Validate Email
            if (!email) {
                document.getElementById('email-error').textContent = 'Email Address is required.';
                hasError = true;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('email-error').textContent = 'Invalid email format.';
                hasError = true;
            } else if (/(test\.com|fake\.com)$/i.test(email)) {
                document.getElementById('email-error').textContent = 'Email domain is not allowed.';
                hasError = true;
            }

            // Validate Password
            if (!password) {
                document.getElementById('password-error').textContent = 'Password is required.';
                hasError = true;
            } else if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(password)) {
                document.getElementById('password-error').textContent = 'Password must be at least 8 characters long and include one number, one uppercase letter, one lowercase letter, and one special character.';
                hasError = true;
            }

            // Validate Confirm Password
            if (!confirmPassword) {
                document.getElementById('confirm-password-error').textContent = 'Please confirm your password.';
                hasError = true;
            } else if (password !== confirmPassword) {
                document.getElementById('confirm-password-error').textContent = 'Passwords do not match.';
                hasError = true;
            }

            if (hasError) return; // Stop execution if there are validation errors

            try {
                const response = await fetch('/api/patient/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        birthday,
                        email,
                        password
                    }),
                });

                if (response.ok) {
                    // Show OTP section and hide the sign-up form
                    document.querySelector('.login-form').classList.add('hidden');
                    document.getElementById('otp-section').classList.remove('hidden');
                } else {
                    const result = await response.json();
                    const errorMessage = result.message || 'An error occurred.';
                    document.getElementById('email-error').textContent = errorMessage;
                }
            } catch (error) {
                console.error('Error creating account:', error);
                document.getElementById('email-error').textContent = 'An unexpected error occurred.';
            }
        });

        document.getElementById('verify-otp-button').addEventListener('click', async function () {
            const email = document.getElementById('email').value.trim();
            const otp = document.getElementById('otp').value.trim();

            if (!otp) {
                document.getElementById('otp-error').textContent = 'OTP is required.';
                return;
            }

            try {
                const response = await fetch('/api/patient/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, otp }),
                });

                if (response.ok) {
                    window.location.href = "login-patient.html";
                } else {
                    const result = await response.json();
                    document.getElementById('otp-error').textContent = result.message || 'Invalid OTP.';
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                document.getElementById('otp-error').textContent = 'An unexpected error occurred.';
            }
        });

        document.getElementById('first-name').addEventListener('input', function () {
            this.value = this.value.slice(0, 20); // Restrict to 20 characters
            this.value = this.value.replace(/[^A-Za-z]/g, ''); // Remove non-letter characters
            if (/^[A-Za-z]{1,20}$/.test(this.value)) {
                document.getElementById('first-name-error').textContent = '';
            }
        });

        document.getElementById('last-name').addEventListener('input', function () {
            this.value = this.value.slice(0, 20); // Restrict to 20 characters
            this.value = this.value.replace(/[^A-Za-z\s]/g, ''); // Allow letters and spaces
            if (/^[A-Za-z\s]{1,20}$/.test(this.value)) {
                document.getElementById('last-name-error').textContent = '';
            }
        });

        document.getElementById('birthday').addEventListener('input', function () {
            const birthDate = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            if (age >= 18) {
                document.getElementById('birthday-error').textContent = ''; // Clear error message
            } else {
                document.getElementById('birthday-error').textContent = 'You must be at least 18 years old.';
            }
        });

        const fakeEmailDomains = [
            "test.com",
            "fake.com",
            "example.com",
            "mailinator.com",
            "dispostable.com",
            "10minutemail.com",
            "guerrillamail.com",
            "sharklasers.com",
            "yopmail.com",
            "trashmail.com",
            "getnada.com",
            "temp-mail.org",
            "maildrop.cc",
            "throwawaymail.com",
            "airmail.com",
            "spamgourmet.com",
            "jetable.org",
            "mailcatch.com",
            "nowmymail.com"
            ];

            document.getElementById('email').addEventListener('input', async function () {
            const email = this.value.trim();
            const emailError = document.getElementById('email-error');

            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isFakeEmail = new RegExp(`(${fakeEmailDomains.join("|").replace(/\./g, "\\.")})$`, "i");

            if (emailPattern.test(email)) {
                if (isFakeEmail.test(email)) {
                emailError.textContent = 'Email address from disposable or fake domains is not allowed.';
                } else {
                try {
                    const response = await fetch(`/api/patient/check-email?email=${encodeURIComponent(email)}`);
                    const result = await response.json();

                    if (response.ok && result.exists) {
                    emailError.textContent = 'Email address is already registered.';
                    } else {
                    emailError.textContent = '';
                    }
                } catch (error) {
                    console.error('Error checking email:', error);
                    emailError.textContent = 'Unable to verify email at the moment.';
                }
                }
            } else {
                emailError.textContent = 'Invalid email format.';
            }
            });


        document.getElementById('password').addEventListener('focus', function () {
            document.getElementById('password-checklist').classList.remove('hidden');
        });

        document.getElementById('password').addEventListener('input', function () {
            const password = this.value;
            const lengthCheck = document.getElementById('length-check');
            const numberCheck = document.getElementById('number-check');
            const uppercaseCheck = document.getElementById('uppercase-check');
            const lowercaseCheck = document.getElementById('lowercase-check');
            const specialCheck = document.getElementById('special-check');
            const checklist = document.getElementById('password-checklist');
            const passwordError = document.getElementById('password-error');

            // Check each requirement and update the checklist
            lengthCheck.classList.toggle('text-green-500', password.length >= 8);
            lengthCheck.classList.toggle('text-gray-500', password.length < 8);

            numberCheck.classList.toggle('text-green-500', /\d/.test(password));
            numberCheck.classList.toggle('text-gray-500', !/\d/.test(password));

            uppercaseCheck.classList.toggle('text-green-500', /[A-Z]/.test(password));
            uppercaseCheck.classList.toggle('text-gray-500', !/[A-Z]/.test(password));

            lowercaseCheck.classList.toggle('text-green-500', /[a-z]/.test(password));
            lowercaseCheck.classList.toggle('text-gray-500', !/[a-z]/.test(password));

            specialCheck.classList.toggle('text-green-500', /[@$!%*?&]/.test(password));
            specialCheck.classList.toggle('text-gray-500', !/[@$!%*?&]/.test(password));

            // Hide checklist and clear error message if all requirements are met
            if (password.length >= 8 && /\d/.test(password) && /[A-Z]/.test(password) && /[a-z]/.test(password) && /[@$!%*?&]/.test(password)) {
                checklist.classList.add('hidden');
                passwordError.textContent = '';
            } else {
                checklist.classList.remove('hidden');
            }
        });

        document.getElementById('confirm-password').addEventListener('input', function () {
            const password = document.getElementById('password').value;
            const confirmPasswordError = document.getElementById('confirm-password-error');

            if (this.value === password) {
                confirmPasswordError.textContent = ''; // Clear error message if passwords match
            } else {
                confirmPasswordError.textContent = 'Passwords do not match.'; // Show error message if they don't match
            }
        });

        document.getElementById('first-name').addEventListener('focus', function () {
            document.getElementById('first-name-error').textContent = 'First Name is required.';
        });

        document.getElementById('last-name').addEventListener('focus', function () {
            document.getElementById('last-name-error').textContent = 'Last Name is required.';
        });

        document.getElementById('birthday').addEventListener('focus', function () {
            document.getElementById('birthday-error').textContent = 'Birthday is required.';
        });

        document.getElementById('email').addEventListener('focus', function () {
            document.getElementById('email-error').textContent = 'Email Address is required.';
        });

        document.getElementById('password').addEventListener('focus', function () {
            document.getElementById('password-error').textContent = 'Password is required.';
        });

        document.getElementById('confirm-password').addEventListener('focus', function () {
            document.getElementById('confirm-password-error').textContent = 'Please confirm your password.';
        });

        document.getElementById('first-name').addEventListener('blur', function () {
            if (!this.value.trim()) {
                document.getElementById('first-name-error').textContent = '';
            }
        });

        document.getElementById('last-name').addEventListener('blur', function () {
            if (!this.value.trim()) {
                document.getElementById('last-name-error').textContent = '';
            }
        });

        document.getElementById('birthday').addEventListener('blur', function () {
            if (!this.value.trim()) {
                document.getElementById('birthday-error').textContent = '';
            }
        });

        document.getElementById('email').addEventListener('blur', function () {
            const email = this.value.trim();
            const emailError = document.getElementById('email-error');
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isFakeEmail = new RegExp(`(${fakeEmailDomains.join("|").replace(/\./g, "\\.")})$`, "i");

            if (emailPattern.test(email) && isFakeEmail.test(email)) {
                emailError.textContent = 'Email address from disposable or fake domains is not allowed.';
            } else if (!email) {
                emailError.textContent = '';
            }
        });

        document.getElementById('password').addEventListener('blur', function () {
            if (!this.value.trim()) {
                document.getElementById('password-error').textContent = '';
            }
        });

        document.getElementById('confirm-password').addEventListener('blur', function () {
            if (!this.value.trim()) {
                document.getElementById('confirm-password-error').textContent = '';
            }
        });
    </script>
</body>

</html>