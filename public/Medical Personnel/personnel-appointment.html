<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Data</title>
    <!-- <link rel="stylesheet" href="../Medical Personnel/mpstyle.css"> -->
    <link href="../output.css" rel="stylesheet">
    <link rel="icon" href="../media/logo/EJPL.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="../components/components-personnel/sidebarfetch-personnel.js"></script>
</head>

<body class="min-h-screen bg-slate-50 flex font-inter">

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-10 hidden lg:hidden z-40"></div>

    <!-- Main Content -->
    <div id="main-content" class="flex-1 lg:ml-64 z-30 overflow-x-hidden">
        <!-- Navbar -->
        <header class="bg-white shadow-md p-2 flex justify-between items-center">
            <!-- Hamburger Menu -->
            <button id="hamburger" class="lg:hidden ml-4 text-[#232931] focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <h1 class="text-xl font-semibold ml-8 text-[#232931] hidden lg:block">Appointments</h1>
            <!-- Notification Bell -->
            <div class="flex items-center gap-4">
                <div class="relative">
                    <!-- Notification Bell -->
                    <button id="notification-bell" class="relative focus:outline-none">
                        <i class="fas fa-bell text-[#232931] text-xl hover:text-gray-600"></i>
                        <span id="notification-count"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full px-1 hidden">0</span>
                    </button>
                    <!-- Notification Dropdown -->
                    <div id="notification-dropdown"
                        class="absolute right-0 mt-2 w-96 bg-white border border-gray-200 rounded-lg shadow-lg hidden z-50">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex gap-2">
                                <button onclick="markSelectedAsRead()"
                                    class="flex-1 py-1 bg-green-500 text-white text-xs font-semibold rounded hover:bg-green-600">Mark
                                    as Read</button>
                                <button onclick="markSelectedAsUnread()"
                                    class="flex-1 py-1 bg-blue-500 text-white text-xs font-semibold rounded hover:bg-blue-600">Mark
                                    as Unread</button>
                                <button onclick="deleteSelectedNotifications()"
                                    class="flex-1 py-1 bg-red-500 text-white text-xs font-semibold rounded hover:bg-red-600">Delete</button>
                            </div>
                        </div>
                        <ul id="notification-list" class="max-h-48 overflow-y-auto p-2 space-y-2">
                            <!-- Notifications will be dynamically added here -->
                            <li class="text-sm text-gray-500 text-center">No notifications</li>
                        </ul>
                    </div>
                </div>
                <div id="mobile-notification-dropdown"
                    class="absolute left-0 mt-[19rem] w-full bg-white border border-gray-200 rounded-none shadow-lg hidden z-50">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex gap-2">
                            <button onclick="markSelectedAsRead()"
                                class="flex-1 py-1 bg-green-500 text-white text-xs font-semibold rounded hover:bg-green-600">Mark
                                as Read</button>
                            <button onclick="markSelectedAsUnread()"
                                class="flex-1 py-1 bg-blue-500 text-white text-xs font-semibold rounded hover:bg-blue-600">Mark
                                as Unread</button>
                            <button onclick="deleteSelectedNotifications()"
                                class="flex-1 py-1 bg-red-500 text-white text-xs font-semibold rounded hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                    <ul id="mobile-notification-list" class="max-h-48 overflow-y-auto p-2 space-y-2">
                        <!-- Notifications will be dynamically added here -->
                        <li class="text-sm text-gray-500 text-center">No notifications</li>
                    </ul>
                </div>
                <div id="profile-container"
                    class="flex items-center bg-white border text-white pl-6 pr-3 py-2 rounded-lg relative group">
                    <img class="w-8 h-8 rounded-full mr-0 lg:mr-3 desktop-profile object-cover" alt="Profile Picture">
                    <div class="hidden lg:block text-left">
                        <span id="profile-name" class="block font-semibold text-[#232931]">Loading...</span>
                        <span class="block text-xs text-[#232931]">Medical Personnel</span>
                    </div>
                    <svg class="w-4 h-4 ml-6 lg:ml-14 text-[#232931]" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    <div id="desktop-profile-dropdown"
                        class="absolute bg-white border text-[#232931] mt-32 right-2 lg:right-auto lg:ml-12 rounded shadow-lg w-40 hidden lg:group-hover:block">
                        <a href="../Medical Personnel/personnel-profile.html"
                            class="block px-4 py-2 hover:bg-gray-100">View Profile</a>
                        <a href="../main page/home.html" class="block px-4 py-2 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
                <div id="mobile-profile-dropdown"
                    class="hidden lg:hidden fixed top-[4rem] left-0 w-full bg-white border text-[#232931] rounded-none shadow-lg z-50">
                    <a href="../Medical Personnel/personnel-profile.html" class="block px-6 py-4 hover:bg-gray-100">View
                        Profile</a>
                    <a href="../main page/home.html" class="block px-6 py-4 hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-6">
            <div class="container mx-auto px-4 lg:px-6 xl:px-8">
                <section id="patient-appointments" class="report-section">
                    <div
                        class="button-container flex flex-col flex-wrap md:flex-row justify-center gap-2 lg:gap-4 my-4">
                        <button
                            class="all-button w-full sm:w-auto px-4 py-2 rounded-md text-[#2C4A66] font-semibold bg-white border-2 border-[#2C4A66] hover:bg-[#2C4A66] hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-400"
                            onclick="filterAppointments('All')">ALL</button>
                        <button
                            class="pending-button w-full sm:w-auto px-4 py-2 rounded-md text-[#2C4A66] font-semibold bg-white border-2 border-[#2C4A66] hover:bg-[#2C4A66] hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-400"
                            onclick="filterAppointments('Pending')">PENDING</button>
                        <button
                            class="confirm-button w-full sm:w-auto px-4 py-2 rounded-md text-[#2C4A66] font-semibold bg-white border-2 border-[#2C4A66] hover:bg-[#2C4A66] hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-400"
                            onclick="filterAppointments('Confirmed')">CONFIRMED</button>
                        <button
                            class="cancel-button w-full sm:w-auto px-4 py-2 rounded-md text-[#2C4A66] font-semibold bg-white border-2 border-[#2C4A66] hover:bg-[#2C4A66] hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-400"
                            onclick="filterAppointments('Cancelled')">CANCELLED</button>
                        <button
                            class="completed-button w-full sm:w-auto px-4 py-2 rounded-md text-[#2C4A66] font-semibold bg-white border-2 border-[#2C4A66] hover:bg-[#2C4A66] hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-400"
                            onclick="filterAppointments('Completed')">COMPLETED</button>
                    </div>

                    <div id="appointments-container" class="overflow-x-auto">
                        <div class="w-full overflow-x-auto">
                            <div class="min-w-[1400px]">
                                <table id="appointments-table" class="w-full border-collapse text-sm text-gray-700">
                                    <caption
                                        class="header text-lg font-semibold text-gray-700 mb-4 mt-4 text-left lg:text-center"
                                        id="appointments-header">Appointment List</caption>
                                    <thead>
                                        <tr class="bg-[#2C4A66] text-white">
                                            <th class="px-4 py-2 text-left">Status</th>
                                            <th class="px-4 py-2 text-left">Reference Number</th>
                                            <th class="px-4 py-2 text-left">Name</th>
                                            <th class="px-4 py-2 text-left">Contact Number</th>
                                            <th class="px-4 py-2 text-left">Date</th>
                                            <th class="px-4 py-2 text-left">Time</th>
                                            <th class="px-4 py-2 text-left">Treatment Type</th>
                                            <th class="px-4 py-2 text-left">Assigned Dentist</th>
                                        </tr>
                                    </thead>
                                    <tbody id="appointments-tbody">
                                        <!-- Appointments will be displayed here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="pagination-container" class="flex justify-center mt-4"></div>
                </section>
            </div>
        </main>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal"
            class="modal fixed inset-0 items-center justify-center bg-black bg-opacity-10 hidden">
            <div class="modal-content bg-white p-6 rounded-lg shadow-lg w-96 relative">
                <button
                    class="absolute top-2 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none"
                    onclick="closeModal()">
                    &times;
                </button>
                <div class="flex flex-col items-center">
                    <div
                        class="bg-[#E3EBF9] text-[#6E80D1] rounded-full w-16 h-16 flex items-center justify-center mb-4">
                        <i class="fas fa-question text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800 text-center">Are you sure?</h2>
                </div>
                <p id="modal-message" class="text-sm text-gray-700 text-center mt-2 mb-4"></p>
                <div class="flex justify-between items-center space-x-4 mt-8">
                    <button id="cancel-button"
                        class="bg-gray-300 text-sm text-gray-700 px-4 py-1 rounded-md hover:bg-gray-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-200"
                        onclick="closeModal()">No</button>
                    <button id="confirm-button"
                        class="bg-[#2C4A66] text-sm text-white px-4 py-1 rounded-md hover:bg-[#1E3A56] focus:outline-none focus:ring-2 focus:ring-blue-400">Yes</button>
                </div>
            </div>
        </div>

        <div id="toast-container" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div id="toast-message" class="bg-blue-500 text-white px-4 py-2 rounded-md shadow-lg"></div>
        </div>

        <script>
            function filterAppointments(status) {
                currentFilter = status; // Store the current filter status

                let filteredAppointments;
                if (status === 'All') {
                    filteredAppointments = allAppointments; // Show all appointments
                    document.getElementById('appointments-header').innerText = 'All Appointments';
                } else {
                    filteredAppointments = allAppointments.filter(appointment => appointment.status === status);
                    document.getElementById('appointments-header').innerText = `${status} Appointments`;
                }

                // Show appointments container
                document.getElementById('appointments-container').style.display = 'block';

                // Ensure dentists are fetched before displaying appointments
                fetchDentists().then(() => {
                    displayAppointments(filteredAppointments);
                }).catch(error => {
                    console.error('Error fetching dentists:', error);
                });

                // Update button styles
                document.querySelectorAll('.button-container button').forEach(button => {
                    button.classList.remove('bg-[#2C4A66]', 'text-white'); // Remove active styles
                    button.classList.add('bg-white', 'text-[#2C4A66]'); // Revert to default styles
                });
                const buttonMap = {
                    'All': '.all-button',
                    'Pending': '.pending-button',
                    'Confirmed': '.confirm-button',
                    'Cancelled': '.cancel-button',
                    'Completed': '.completed-button'
                };
                if (buttonMap[status]) {
                    const activeButton = document.querySelector(buttonMap[status]);
                    activeButton.classList.remove('bg-white', 'text-[#2C4A66]'); // Remove default styles
                    activeButton.classList.add('bg-[#2C4A66]', 'text-white'); // Apply active styles
                }
            }
        </script>
        <script>
            let allAppointments = [];
            let pendingUpdate = null;
            let currentFilter = 'All'; // Default status is "All"
            let cachedDentists = [];  // Cache dentists here

            async function fetchAppointments() {
                const tbody = document.getElementById('appointments-tbody');
                tbody.innerHTML = `
                    <tr id="loading-row">
                        <td colspan="8" class="text-center text-gray-500 py-6">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-spinner fa-spin text-4xl mb-2 text-gray-400"></i>
                                <p class="text-lg font-semibold">Loading appointments...</p>
                            </div>
                        </td>
                    </tr>
                `; // Show loading state

                try {
                    const response = await fetch('/api/appointments');
                    if (response.ok) {
                        allAppointments = await response.json();
                        setTimeout(() => { // Add a delay to ensure data is fetched
                            if (allAppointments.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 font-medium py-4 border border-gray-300">No appointments found.</td></tr>';
                            } else {
                                displayAppointments(allAppointments);
                            }
                        }, 500); // Delay of 500ms
                    } else {
                        console.error('Failed to fetch appointments:', response.status, response.statusText);
                        showToast('Failed to fetch appointments. Please try again later.', 'error');
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500 font-medium py-4">Error fetching appointments.</td></tr>';
                    }
                } catch (error) {
                    console.error('Error fetching appointments:', error);
                    showToast('An error occurred while fetching appointments. Please check your connection.', 'error');
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500 font-medium py-4">Error fetching appointments. Please try again later.</td></tr>';
                }
            }

            // Fetch dentists once and cache the result
            async function fetchDentists() {
                if (cachedDentists.length === 0) {
                    try {
                        const response = await fetch('/api/dentists'); // Fetch dentists from API
                        if (response.ok) {
                            cachedDentists = await response.json();  // Cache dentists
                        } else {
                            console.error('Failed to fetch dentists:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error fetching dentists:', error);
                    }
                }
                return cachedDentists;
            }

            async function displayAppointments(appointments) {
                const tbody = document.getElementById('appointments-tbody');
                const paginationContainer = document.getElementById('pagination-container');
                const itemsPerPage = 5; // Maximum appointments per page
                let currentPage = 1;

                function renderPage(page) {
                    tbody.innerHTML = ''; // Clear existing appointments
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, appointments.length);
                    const dentists = cachedDentists; // Use cached dentists

                    if (appointments.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 font-medium py-4 border border-gray-300">No appointments found.</td></tr>';
                        paginationContainer.innerHTML = ''; // Clear pagination
                        return;
                    }

                    for (let i = startIndex; i < endIndex; i++) {
                        const appointment = appointments[i];
                        const formattedDate = new Date(appointment.preferredDate).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        let assignedDentistName = 'Not Assigned';
                        if (appointment.assignedDentist) {
                            const assignedDentist = dentists.find(dentist => dentist._id === appointment.assignedDentist);
                            if (assignedDentist) {
                                const prefix = assignedDentist.gender === 'male' ? 'Dr.' : 'Dra.';
                                assignedDentistName = `${prefix} ${assignedDentist.firstName} ${assignedDentist.lastName}`;
                            }
                        }

                        const dentistSelect = dentists
                            .filter(dentist => dentist._id !== appointment.assignedDentist)
                            .map(dentist => {
                                const prefix = dentist.gender === 'male' ? 'Dr.' : 'Dra.';
                                return `
                                    <option value="${dentist._id}">
                                        ${prefix} ${dentist.firstName} ${dentist.lastName}
                                    </option>
                                `;
                            }).join('');

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="status-cell ${appointment.status} border-t border-b border-l border-gray-300 px-4 py-2">
                                <select class="w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    onchange="updateStatus('${appointment._id}', this.value, this)"
                                    data-original-status="${appointment.status}" 
                                    data-appointment-id="${appointment._id}">
                                    <option value="Pending" ${appointment.status === 'Pending' ? 'selected' : ''} ${appointment.status === 'Confirmed' || appointment.status === 'Cancelled' ? 'disabled' : ''}>Pending</option>
                                    <option value="Confirmed" ${appointment.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="Cancelled" ${appointment.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    <option value="Completed" ${appointment.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </td>
                            <td class="border-t border-b px-4 py-2">${appointment.referenceNumber}</td>
                            <td class="border-t border-b px-4 py-2">${appointment.firstName} ${appointment.lastName}</td>
                            <td class="border-t border-b px-4 py-2">${appointment.contactNumber}</td>
                            <td class="border-t border-b px-4 py-2">${formattedDate}</td>
                            <td class="border-t border-b px-4 py-2">${appointment.preferredTime}</td>
                            <td class="border-t border-b px-4 py-2">${appointment.treatmentType}</td>
                            <td class="border-t border-b border-r border-gray-300 px-4 py-2">
                                <select class="w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    onchange="assignDentist('${appointment._id}', this.value)" 
                                    data-appointment-id="${appointment._id}">
                                    <option value="">${assignedDentistName}</option>
                                    ${dentistSelect}
                                </select>
                            </td>
                            <td class="hidden">
                                <div id="message-${appointment._id}" class="message-box hidden text-sm mt-2"></div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }

                    renderPagination();
                }

                function renderPagination() {
                    const totalPages = Math.ceil(appointments.length / itemsPerPage);
                    paginationContainer.innerHTML = ''; // Clear existing pagination

                    if (totalPages <= 1) return; // No pagination needed for 1 or fewer pages

                    const maxVisiblePages = 3; // Maximum number of visible page buttons
                    const startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                    const endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                    // Previous arrow
                    if (currentPage > 1) {
                        const prevButton = document.createElement('button');
                        prevButton.innerHTML = "<span class='font-bold'>&lt;</span>"; // Use < for previous
                        prevButton.className = 'px-3 py-1 mx-1 bg-gray-200 text-gray-700 rounded-md';
                        prevButton.onclick = () => {
                            currentPage--;
                            renderPage(currentPage);
                        };
                        paginationContainer.appendChild(prevButton);
                    }

                    // Page buttons
                    for (let i = startPage; i <= endPage; i++) {
                        const button = document.createElement('button');
                        button.innerText = i;
                        button.className = `px-3 py-1 mx-1 rounded-md ${i === currentPage ? 'bg-[#2C4A66] text-white' : 'bg-gray-200 text-gray-700'}`;
                        button.onclick = () => {
                            currentPage = i;
                            renderPage(currentPage);
                        };
                        paginationContainer.appendChild(button);
                    }

                    // Next arrow
                    if (currentPage < totalPages) {
                        const nextButton = document.createElement('button');
                        nextButton.innerHTML = "<span class='font-bold'>&gt;</span>"; // Use > for next
                        nextButton.className = 'px-3 py-1 mx-1 bg-gray-200 text-gray-700 rounded-md';
                        nextButton.onclick = () => {
                            currentPage++;
                            renderPage(currentPage);
                        };
                        paginationContainer.appendChild(nextButton);
                    }
                }

                renderPage(currentPage);
            }

            function updateStatus(appointmentId, newStatus, selectElement) {
                const currentStatus = selectElement.dataset.originalStatus;

                // Ensure a dentist is assigned before confirming
                if (newStatus === 'Confirmed') {
                    const row = selectElement.closest('tr');
                    const dentistSelect = row.querySelector('td:nth-child(8) select');
                    if (!dentistSelect || !dentistSelect.value || dentistSelect.value === "Not Assigned") {
                        showToast('Please assign a dentist before confirming the appointment.', 'error');
                        selectElement.value = currentStatus; // Revert to the original status
                        return;
                    }
                }

                if (currentStatus === newStatus) return;
                openModal(`Confirm change of status to ${newStatus}?`, appointmentId, newStatus, selectElement);
            }

            function openModal(message, appointmentId, newStatus, selectElement) {
                document.getElementById('modal-message').innerText = message;
                document.getElementById('confirmation-modal').style.display = 'flex';
                pendingUpdate = { appointmentId, newStatus, selectElement };
            }

            function closeModal() {
                if (pendingUpdate) {
                    pendingUpdate.selectElement.value = pendingUpdate.selectElement.dataset.originalStatus;
                    pendingUpdate = null;
                }
                document.getElementById('confirmation-modal').style.display = 'none';
            }

            document.getElementById('confirm-button').onclick = async function () {
                if (pendingUpdate) {
                    const { appointmentId, newStatus, selectElement } = pendingUpdate;
                    const response = await fetch(`/api/appointments/${appointmentId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus }),
                    });

                    if (response.ok) {
                        selectElement.dataset.originalStatus = newStatus;
                        selectElement.value = newStatus;
                        showMessage(selectElement, 'Status updated successfully!', 'success');
                    } else {
                        showMessage(selectElement, 'Failed to update status.', 'error');
                    }
                    closeModal();
                }
            };

            function showMessage(selectElement, message, type) {
                const messageBox = document.getElementById(`message-${selectElement.dataset.appointmentId}`);
                if (!messageBox) {
                    console.error("Message box not found for appointment:", selectElement.dataset.appointmentId);
                    return;
                }
                messageBox.innerText = message;
                messageBox.className = `message-box ${type}`;
                messageBox.style.display = 'block';
                setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
            }

            let pendingDentistAssignment = null;

            async function assignDentist(appointmentId, dentistId) {
                if (!dentistId) return; // Prevent empty selection

                // Store pending assignment details
                pendingDentistAssignment = { appointmentId, dentistId };

                // Show the custom modal
                document.getElementById('assign-dentist-modal').style.display = 'flex';
            }

            function closeAssignDentistModal() {
                if (pendingDentistAssignment) {
                    const { appointmentId } = pendingDentistAssignment;

                    // Find the dropdown for the appointment and reset it to "Not Assigned"
                    const dropdown = document.querySelector(`select[data-appointment-id="${appointmentId}"]`);
                    if (dropdown) {
                        dropdown.value = ""; // Reset to "Not Assigned"
                        dropdown.dispatchEvent(new Event('change')); // Trigger change event to ensure UI updates
                    }

                    // Update the UI to reflect "Not Assigned"
                    const row = dropdown.closest('tr');
                    if (row) {
                        const dentistCell = row.querySelector('td:nth-child(8)');
                        if (dentistCell) {
                            dentistCell.textContent = "Not Assigned";
                        }
                    }
                }

                pendingDentistAssignment = null; // Clear pending assignment
                document.getElementById('assign-dentist-modal').style.display = 'none';
            }

            document.addEventListener('DOMContentLoaded', () => {
                const assignConfirmButton = document.getElementById('assign-confirm-button');
                const assignCancelButton = document.getElementById('assign-cancel-button');

                if (assignConfirmButton) {
                    assignConfirmButton.onclick = async function () {
                        if (!pendingDentistAssignment) return;

                        const { appointmentId, dentistId } = pendingDentistAssignment;

                        try {
                            const response = await fetch(`/api/appointments/${appointmentId}/assign-dentist`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ assignedDentist: dentistId }),
                            });

                            if (response.ok) {
                                const updatedAppointment = await response.json();

                                // Update the UI to reflect the assigned dentist
                                const dropdown = document.querySelector(`select[data-appointment-id="${appointmentId}"]`);
                                if (dropdown) {
                                    const row = dropdown.closest('tr');
                                    const dentistCell = row.querySelector('td:nth-child(8)');
                                    if (dentistCell) {
                                        const assignedDentist = cachedDentists.find(dentist => dentist._id === dentistId);
                                        if (assignedDentist) {
                                            const prefix = assignedDentist.gender === 'male' ? 'Dr.' : 'Dra.';
                                            dentistCell.textContent = `${prefix} ${assignedDentist.firstName} ${assignedDentist.lastName}`;
                                        }
                                    }
                                }

                                showToast('Dentist has been successfully assigned.', 'success');
                            } else {
                                const errorData = await response.json();
                                console.error('Failed to assign dentist:', errorData.error || response.statusText);
                                showToast(`Failed to assign dentist: ${errorData.error || 'Unknown error'}`, 'error');
                            }
                        } catch (error) {
                            console.error('Error assigning dentist:', error.message || error);
                            showToast('An error occurred while assigning the dentist. Please try again.', 'error');
                        } finally {
                            closeAssignDentistModal();
                        }
                    };
                }

                if (assignCancelButton) {
                    assignCancelButton.onclick = closeAssignDentistModal;
                }
            });

            function showToast(message, type) {
                const toastContainer = document.getElementById('toast-container');
                const toastMessage = document.getElementById('toast-message');

                toastMessage.innerText = message;
                toastMessage.className = `px-4 py-2 rounded-md shadow-lg ${type === 'success' ? 'bg-blue-500 text-white' : 'bg-red-500 text-white'
                    }`;

                toastContainer.classList.remove('hidden');
                setTimeout(() => {
                    toastContainer.classList.add('hidden');
                }, 3000);
            }

            window.onload = fetchAppointments;
            window.onclick = function (event) {
                const modal = document.getElementById('confirmation-modal');
                if (event.target === modal) closeModal();
            }

            document.addEventListener('DOMContentLoaded', async () => {
                const profileResponse = await fetch('/api/medicalPersonnel/profile');
                if (profileResponse.ok) {
                    const personnelData = await profileResponse.json();
                    displayProfileInfo(personnelData);

                    // Set the profile picture if available
                    const profilePictureElement = document.querySelector('.desktop-profile');
                    profilePictureElement.src = personnelData.profilePicture
                        ? `/uploads/${personnelData.profilePicture}`
                        : '../media/logo/default-profile.png';
                }

                // Ensure the alert-ok-button exists before setting its onclick
                const alertOkButton = document.getElementById('alert-ok-button');
                if (alertOkButton) {
                    alertOkButton.onclick = function () {
                        document.getElementById('alert-modal').style.display = 'none';
                        location.reload();
                    };
                }
            });

            function displayProfileInfo(data) {
                document.getElementById('profile-name').innerText = `${data.firstName}`;
            }
        </script>
        <script src="personnelnotification.js"></script>
        <script src="../components/components-personnel/navbarpersonnel-functionalities.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const profileResponse = await fetch('/api/medicalPersonnel/profile');
                if (profileResponse.ok) {
                    const personnelData = await profileResponse.json();
                    displayProfileInfo(personnelData);

                    // Set the profile picture if available
                    const profilePictureElement = document.querySelector('.desktop-profile');
                    profilePictureElement.src = personnelData.profilePicture
                        ? `/uploads/${personnelData.profilePicture}`
                        : '../media/logo/default-profile.png';
                }
            });

            function displayProfileInfo(data) {
                document.getElementById('profile-name').innerText = `${data.firstName}`;
            }
        </script>

        <!-- Dentist Assignment Confirmation Modal -->
        <div id="assign-dentist-modal"
            class="modal fixed inset-0 items-center justify-center bg-black bg-opacity-10 hidden">
            <div class="modal-content bg-white p-6 rounded-lg shadow-lg w-96 relative">
                <button
                    class="absolute top-2 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none"
                    onclick="closeAssignDentistModal()">
                    &times;
                </button>
                <div class="flex flex-col items-center">
                    <div
                        class="bg-[#E3EBF9] text-[#6E80D1] rounded-full w-16 h-16 flex items-center justify-center mb-4">
                        <i class="fas fa-question text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800 text-center">Are you sure?</h2>
                </div>
                <p class="text-sm text-gray-700 text-center mt-2 mb-4">Do you want to assign this dentist?</p>
                <div class="flex justify-between items-center space-x-4 mt-8">
                    <button id="assign-cancel-button"
                        class="bg-gray-300 text-sm text-gray-700 px-4 py-1 rounded-md hover:bg-gray-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-200"
                        onclick="closeAssignDentistModal()">No</button>
                    <button id="assign-confirm-button"
                        class="bg-[#2C4A66] text-sm text-white px-4 py-1 rounded-md hover:bg-[#1E3A56] focus:outline-none focus:ring-2 focus:ring-blue-400">Yes</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>